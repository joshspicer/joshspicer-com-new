<!doctype html>
<html>
  <head>
    <meta content='Create your own embeddable Spotify "Now Playing" with AWS Lambda - Josh Spicer' property='og:title' />
    <title>Create your own embeddable Spotify "Now Playing" with AWS Lambda - Josh Spicer</title>
    <!-- Charset and Facebook Like link-->
	<meta content='text/html; charset=utf-8' http-equiv='content-type' />
	<meta content="" property="fb:app_id" />
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
<!-- Custom Meta Content -->
	<meta name="description" content="computer science student at northeastern university">
	
		<meta content='http://localhost:4000/spotify-lambda' property='og:url' />
		<meta content="I love Spotify, and I love discovering new music based on my friend’s music feed. More wordsmore words more words mor..." property='og:description' />
		<meta content="article" property="og:type" />
		
<!-- /Custom Meta Content -->
<!-- Viewport and device width -->
	<meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'>
	<meta name="apple-mobile-web-app-capable" content="yes">
<!-- Windows 8 / RT -->
	<meta name="msapplication-TileImage" content="images/apple-touch-icon-144x144-precomposed.png">
	<meta name="msapplication-TileColor" content="#000">
	<meta http-equiv="cleartype" content="on">
	<link href='http://localhost:4000/images/favicon.png' rel='shortcut icon'>
<!-- Main Stylesheet -->
	<link href='http://localhost:4000/stylesheets/style.css' rel='stylesheet' type='text/css' />
<!-- Syntax Highlight Stylesheet -->
	<link href='http://localhost:4000/stylesheets/github.css' rel='stylesheet' type='text/css' />
<!-- Main Theme Stylesheet -->
	<link href='http://localhost:4000/stylesheets/theme.css' rel='stylesheet' type='text/css' />

<!-- Josh Custom -->
<script src="../../js/pollLambdaAPI.js"></script>

<!-- font awesome -->
<script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js" integrity="sha384-3LK/3kTpDE/Pkp8gTNp2gR/2gOiwQ6QaO7Td0zV76UFJVhqLl4Vl3KL1We6q6wR9" crossorigin="anonymous"></script>

<!-- Random line at top of screen. -->
<hr style="border: 1px solid black;top:0;width:100%;margin:0" />

<!-- Lodash -->
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script>

	<!--[if lt IE 9]>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.js"></script>
	<![endif]-->

  </head>
  <body>
    <div class="container">
	<div class="row">
		<div class="col12">
			<nav class="nav-top">
				<ul class="menu-list" id="nav">
				
					<li>
						<a target="_top" href="/about">About</a>
					</li>
				
					<li>
						<a target="_top" href="/">Notes</a>
					</li>
				
					<li>
						<a target="_top" href="/archive">Archive</a>
					</li>
				
			  </ul>
			</nav>
		</div>
	</div>
</div>

    <div class="container">
	<div class="row">
		<div class="col12">
			<header class="blog-title">
				<!-- <a href="/about"><img style="border-radius: 50%"; src="http://localhost:4000/images/theme-logo.png" alt="Josh Spicer" width="230" height="230"></a> -->
				<h1>Josh Spicer</h1>
				<ui>
					
				<span style="padding:0;margin:0">
					<a style="padding:0;margin:0"href="http://instagram.com/joshspicer_" target="_blank">
							<i
									style="color:black;font-size:23px;"
									 onMouseOver="this.style.color='#F7C277'" class="fab fa-instagram"></i>
					</a>
				</span>
					
				<span style="padding:0;margin:0">
					<a style="padding:0;margin:0"href="http://github.com/joshspicer" target="_blank">
							<i
									style="color:black;font-size:23px;"
									 onMouseOver="this.style.color='#25292E'" class="fab fa-github"></i>
					</a>
				</span>
					
				<span style="padding:0;margin:0">
					<a style="padding:0;margin:0"href="http://linkedin.com/in/joshspicer" target="_blank">
							<i
									style="color:black;font-size:23px;"
									 onMouseOver="this.style.color='#6AABE9'" class="fab fa-linkedin"></i>
					</a>
				</span>
					
				<span style="padding:0;margin:0">
					<a style="padding:0;margin:0"href="https://facebook.com/spicer.josh" target="_blank">
							<i
									style="color:black;font-size:23px;"
									 onMouseOver="this.style.color='#3B5998'" class="fab fa-facebook"></i>
					</a>
				</span>
					
				<span style="padding:0;margin:0">
					<a style="padding:0;margin:0"href="https://open.spotify.com/user/joshspicer37" target="_blank">
							<i
									style="color:black;font-size:23px;"
									 onMouseOver="this.style.color='#1db954'" class="fab fa-spotify"></i>
					</a>
				</span>
					
				</ui>
				<!-- Social Media -->

					<!-- Josh's Spotify Lambda function -->
				<p>
          <span id='spotify'>computer science student at northeastern university</span>
				</p>
				<a href="http://localhost:4000/test-spotify"><h5>add a song to my queue!</h5></a>
			</header>
		</div>
	</div>
</div>

    <div class='container'>
      <div class="row">
        <div class="col12">
          <section class='post'>
            <article class="post-entry">
              <span class='date'>21 Jun 2018</span>
              <span class="paging">
  
    <div class="left">
      <a class="to-top" href="/parade" title="go back">
        ‹
      </a>
    </div>
  
  
</span>
              <h1 class="post-title">
              Create your own embeddable Spotify "Now Playing" with AWS Lambda
              </h1>
              <span class='post-contents'>
              <p>I love Spotify, and I love discovering new music based on my friend’s music feed. More words
more words more words more words more words more words more words more words.</p>

<p>#TODO: image of it working on my website.</p>

<p>You can see the endpoint working at https://lambda.joshspicer.com/v1/current</p>

<h2>Overview</h2>

<p>In this guide we will be hosting a function on AWS Lambda, and using Spotify’s web API to return a JSON object with the user’s
current or last played Spotify track. We will utilize Amazon’s API Gateway to create a REST endpoint that can be used anywhere
(I use it on my personal website). I wrote the lambda function in python, but this should be easily adaptable to work with any language.</p>

<h2>Prereqs</h2>
<ul>
  <li>AWS Account (Free Tier is all we’ll need)</li>
  <li>Spotify account (premium?)</li>
  <li>Optional: Domain to point API at</li>
</ul>

<h2>Create Developer Account</h2>

<p>The first step is to visit the <a href="https://developer.spotify.com/dashboard/">Spotify developer dashboard</a> and create a new project. This process will grant you a
Client ID and Client Secret. You’ll need to base64 encode these two values with a colon separating them.</p>

<p>Encoding the token can be done by this simple shell command.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo -n &lt;clientId&gt;:&lt;clientSecret&gt; | base64
</code></pre></div></div>

<p>You’ll also need to add a callback URI. For this tutorial it doesn’t matter <em>what</em> the URI is,
as long as you set one and it’s consistent in all the following steps. I used <code class="highlighter-rouge">http://localhost/callback</code>.</p>

<p><img src="../assets/resources-spotify-lambda-post/spotify-callback.png" alt="spotify-callback" /></p>

<h2>Generate Refresh Token</h2>

<p>Spotify’s API requires direct user authorization to access information like current track.
User resources can only be requested by <em>that</em> user, so this means we need to be logged
in as ourselves in order to get the information we need. The problem with this is that Spotify authorization
tokens only last 60 minutes, so we would typically need to log in hourly in order to keep this running. By requesting a
refresh token and writing some code, we can continually grant ourselves a new access token without any user interaction.</p>

<p>#TODO: add more info about the authorization flows.</p>

<p>You’ll need a refresh token to kick it off, which you can generate by asking Spotify for it.
Make sure to provide the correct scopes <code class="highlighter-rouge">user-read-currently-playing</code>,  <code class="highlighter-rouge">user-read-playback-state</code>, <code class="highlighter-rouge">user-read-recently-played</code>, etc as needed.</p>

<p>Visit this URL with your information filled in. This is where Spotify will ask you to login.
After successfully authenticating, you’ll see an access code in the URL. Save that for the next step.</p>

<p><code class="highlighter-rouge">https://accounts.spotify.com/authorize?client_id=&lt;YOUR CLIENT ID&gt;&amp;redirect_uri=&lt;YOUR REDIRECT URI&gt;&amp;response_type=code&amp;scope=&lt;YOUR SCOPES&gt;</code></p>

<p>Issue this curl command in your shell with the access code you just generated.</p>

<p><code class="highlighter-rouge">curl -H "Authorization: Basic &lt;YOUR BASE-64'd APP TOKEN&gt;" -d grant_type=authorization_code -d code=&lt;YOUR ACCESS CODE&gt; -d redirect_uri=&lt;YOUR CALLBACK URL&gt;
https://accounts.spotify.com/api/token</code></p>

<p>You should now have a refresh token, which you call upon to refresh your access token as necessary (more on this later).</p>

<h2>Start a new Lambda Project</h2>

<p>Lambda, for those unfamiliar, is a compute platform that allows you to run code in the cloud without
the hassle of configuring an entire server instance. Code can be running by hitting a REST endpoint.</p>

<p>Navigate to the <a href="https://us-east-2.console.aws.amazon.com/lambda/home?region=us-east-2#/functions">AWS Lambda page</a> and create a new function. I’ll be making my function in region us-east-2.
Create a role that permits basic Amazon Lambda execution, as well as Dynamo DB access (you’ll need that later). I named my role <code class="highlighter-rouge">spotify-listener</code>.</p>

<p><img src="../assets/resources-spotify-lambda-post/create-lambda.png" alt="create-function-photo" /></p>

<p>…….</p>

<p>……</p>

<p>……..</p>

<p>…..</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Only called if the current accessToken is expired (on first visit after ~1hr)
def refreshTheToken(refreshToken):

    clientIdClientSecret = 'Basic &lt;YOUR BASE-64'd APP TOKEN&gt;'
    data = {'grant_type': 'refresh_token', 'refresh_token': &lt;YOUR REFRESH TOKEN&gt;}

    headers = {'Authorization': clientIdClientSecret}
    p = requests.post('https://accounts.spotify.com/api/token', data=data, headers=headers)

    spotifyToken = p.json()

    # Place the expiration time (current time + almost an hour), and access token into the DB
    table.put_item(Item={'spotify': 'prod', 'expiresAt': int(time.time()) + 3200,
                                        'accessToken': spotifyToken['access_token']})
</code></pre></div></div>

<p>…..</p>

<p>…..</p>

<h2>Steps</h2>
<ul>
  <li>Create Developer app</li>
  <li>Get REFRESH token (put curl command, with correct scopes!)…. /authorize, then me/…</li>
  <li>https://developer.spotify.com/documentation/general/guides/authorization-guide/</li>
  <li>Start Lambda Project python</li>
  <li>Download dependencies with pip, copy into online IDE (requests)</li>
  <li>DynamoDB setup (store accessToken and timeSince to not keep querying spotify).</li>
  <li>API Gateway (set up Path)</li>
  <li>Optional: Set up your own DNS.</li>
  <li>CODE: my python code that parses the javascript.  &lt;—make return value more user-friendly.</li>
  <li>Base64-encode the client ID and client secret?</li>
  <li>CODE: Client-side Javascript catcher (Copy/paste-able)</li>
  <li>How to embed.</li>
</ul>

<p>#TODO: Attach entire gist of python code.</p>

<ul>
  <li>TODO: Queue song to my playlist from web interface</li>
  <li>TODO: Album art as header of website.</li>
</ul>

<script src="https://gist.github.com/joshspicer/keybase.js"></script>


            </span>
            <br />
<p>
  Questions?<br/>
  <a href="mailto:hello@joshspicer.com">let me know!</a>
</p>

            </article>
          </section>
        </div>
      </div>
      

    </div>
    <footer>
	<div class="container">
		<div class="row">
			<div class="col6">
				<div class="copyright">
					&copy; 2018 Josh Spicer - <a href="https://github.com/joshspicer/sasa-jekyll-theme">Credits/Source</a>
				</div>
			</div>
			<div class="col6">
				<nav class="social-links">
					<ul class="menu-list">
						
						<a href="http://instagram.com/joshspicer_" target="_blank">
								<i style="font-size:35px;color:#F7C277" class="fab fa-instagram"></i>
						</a>
						
						<a href="http://github.com/joshspicer" target="_blank">
								<i style="font-size:35px;color:#25292E" class="fab fa-github"></i>
						</a>
						
						<a href="http://linkedin.com/in/joshspicer" target="_blank">
								<i style="font-size:35px;color:#6AABE9" class="fab fa-linkedin"></i>
						</a>
						
						<a href="https://facebook.com/spicer.josh" target="_blank">
								<i style="font-size:35px;color:#3B5998" class="fab fa-facebook"></i>
						</a>
						
						<a href="https://open.spotify.com/user/joshspicer37" target="_blank">
								<i style="font-size:35px;color:#1db954" class="fab fa-spotify"></i>
						</a>
						
					</ul>
				</nav>
			</div>
		</div>
	</div>
</footer>
<!--Include JavaScript files at bottom-->
<script src='http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.3.0/respond.js'></script>
<script src='http://localhost:4000/javascripts/jquery.min.js'></script>
<script src='http://localhost:4000/javascripts/prettydate.min.js'></script>
<script src='http://localhost:4000/javascripts/highlight.pack.js'></script>
<script src='http://localhost:4000/javascripts/custom.min.js'></script>
<!--Init Sybtax Highlighter-->
<script>
$(document).ready(function() {
  $("pre code").each(function(i, e) {
    hljs.highlightBlock(e);
  });
});
//hljs.initHighlightingOnLoad();
</script>
<!--Include Analytics, place your ID code on _config.yml file-->
<script>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', '']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  //]]>
</script>

  </body>
</html>
